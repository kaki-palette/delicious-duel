<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デリシャスデュエル - 究極の美食カード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f0f2f5;
            --card-frame: #fbc531;
            --gold: #ffd700;
            --silver: #bdc3c7;
            --gold-aura: rgba(255, 215, 0, 0.6);
        }

        body {
            background: radial-gradient(circle, #ffffff 0%, #dfe6e9 100%);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            color: #2d3436;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-container {
            width: 360px;
            height: 540px;
            perspective: 2000px;
            margin: 20px auto;
        }

        #card-preview {
            width: 360px;
            height: 540px;
            background: #fffdfa;
            border-radius: 24px;
            padding: 20px;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            border: 12px solid var(--card-frame);
            overflow: hidden;
            transform-style: preserve-3d;
            background-clip: padding-box;
            box-sizing: border-box;
        }

        #card-preview.active { 
            display: flex; 
            animation: cardAppear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
        }

        .effect-ur {
            border-color: var(--gold) !important;
            box-shadow: 0 0 50px var(--gold-aura), inset 0 0 20px var(--gold-aura) !important;
            animation: god-float 3s infinite ease-in-out !important;
        }
        
        .is-exporting {
            animation: none !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .shine-layer {
            position: absolute;
            inset: 0;
            z-index: 32;
            pointer-events: none;
            opacity: 0;
            background: linear-gradient(105deg, transparent 30%, rgba(255,255,255,0.4) 45%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.4) 55%, transparent 70%);
            background-size: 200% 200%;
        }
        .effect-ur .shine-layer { opacity: 1; animation: shine-sweep 3s infinite linear; }

        @keyframes god-float {
            0%, 100% { transform: translateY(0) rotateX(0deg); }
            50% { transform: translateY(-10px) rotateX(2deg); }
        }

        @keyframes cardAppear { 0% { transform: scale(0.5) rotateY(90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0); opacity: 1; } }

        .effect-sr {
            border-color: var(--silver) !important;
            box-shadow: 0 0 25px rgba(189, 195, 199, 0.6) !important;
        }

        .photo-frame {
            width: 100%;
            height: 200px;
            border: 4px solid #fff;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            z-index: 10;
            background: #f1f2f6;
        }
        #card-img-el { width: 100%; height: 100%; object-fit: cover; }

        .description-box {
            flex-grow: 1;
            padding: 12px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            border: 2px dashed #dfe6e9;
            margin-bottom: 75px; 
            z-index: 10;
        }

        #praise-text { font-size: 11px; font-weight: 700; line-height: 1.4; color: #2d3436; }

        .rank-badge {
            position: absolute;
            bottom: 35px; 
            left: 20px;
            background: white;
            padding: 4px 12px;
            border-radius: 15px;
            border: 3px solid #fbc531;
            z-index: 40;
            text-align: center;
        }
        .rank-val { font-size: 24px; font-weight: 900; color: #ff7675; line-height: 1; }

        .battle-stats {
            position: absolute;
            bottom: 35px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 40;
        }
        .stat-box {
            background: #2d3436;
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
            min-width: 65px;
        }
        .stat-num { font-size: 16px; font-weight: 900; line-height: 1.1; }

        #main-form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        .ui-card { background: white; border-radius: 35px; padding: 2.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 100%; }
        .input-jp { width: 100%; background: #f1f2f6; border: 3px solid transparent; border-radius: 18px; padding: 14px 22px; font-weight: 800; margin-bottom: 1rem; }
        .btn-action { background: #fbc531; color: #2d3436; padding: 1.2rem; border-radius: 22px; font-weight: 900; width: 100%; box-shadow: 0 6px 0 #e1b12c; cursor: pointer; transition: all 0.2s; }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 2px 0 #e1b12c; }

        #loading-screen {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }

        #error-log {
            display: none;
            background: #ffeaa7;
            color: #d63031;
            padding: 15px;
            margin-top: 20px;
            border-radius: 15px;
            font-size: 12px;
            font-family: monospace;
            max-width: 100%;
            word-break: break-all;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="p-4">

    <header class="text-center mt-6 mb-4">
        <h1 class="text-3xl md:text-5xl font-black text-blue-500 italic">美味決闘 <span class="text-yellow-500">デリシャスデュエル</span></h1>
    </header>

    <div id="main-form-container">
        <div class="ui-card">
            <input type="text" id="input-dish" class="input-jp" placeholder="料理の名前">
            <input type="text" id="input-shop" class="input-jp" placeholder="お店の名前">
            <textarea id="input-points" class="input-jp h-24" placeholder="美食ポイント（想いを込めるほどレア度UP！）"></textarea>
            
            <label class="block cursor-pointer">
                <div class="border-4 border-dashed border-slate-200 rounded-[25px] py-8 flex flex-col items-center hover:bg-slate-50 transition">
                    <span class="text-sm font-black text-slate-500">写真をアップロードして鑑定開始</span>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>
            <div id="error-log"></div>
        </div>
    </div>

    <div id="loading-screen">
        <div class="text-2xl font-black text-yellow-500 mb-4 text-center">AI鑑定員が実食中...<br><span class="text-sm text-slate-400">（解析には時間がかかる場合があります）</span></div>
        <div id="pos-message" class="text-lg font-bold text-slate-500"></div>
    </div>

    <div id="result-area" class="hidden flex-col items-center mt-10 w-full">
        <div class="card-container">
            <div id="card-preview">
                <div class="shine-layer"></div>
                <div class="mb-2">
                    <div class="flex justify-between items-center">
                        <div class="border-2 border-slate-800 p-2 rounded bg-white flex-grow mr-2 overflow-hidden">
                            <h3 id="card-name" class="font-black text-sm whitespace-nowrap">---</h3>
                        </div>
                        <div id="rarity-icon" class="w-10 h-10 bg-slate-800 text-yellow-400 rounded-full flex items-center justify-center font-black flex-shrink-0">-</div>
                    </div>
                </div>
                <div class="photo-frame"><img src="" id="card-img-el"></div>
                <div class="description-box"><p id="praise-text"></p></div>
                <div class="rank-badge"><div class="rank-val" id="val-score">00</div></div>
                <div class="battle-stats">
                    <div class="stat-box"><div class="stat-num" id="val-atk">0</div></div>
                    <div class="stat-box"><div class="stat-num" id="val-def">0</div></div>
                </div>
            </div>
        </div>
        <button id="download-btn" class="btn-action mt-6 max-w-sm">このカードを保存する</button>
        <button onclick="location.reload()" class="mt-4 text-slate-400 underline font-bold">もう一度作る</button>
    </div>

    <script>
        const apiKey = "AIzaSyA2WqHiSSRHx9yKpJFe8SNcIdTBrW09TEc"; 

        const messages = ["香りを分析中...", "旨味成分を計算中...", "隠し味を特定中...", "伝説のレシピと照合中...", "最高の一言を考案中..."];
        let msgIndex = 0;

        function showError(msg, details = "") {
            const log = document.getElementById('error-log');
            log.style.display = 'block';
            log.innerText = `【鑑定失敗】\nエラー: ${msg}\n詳細: ${details}`;
            console.error("Full Error Info:", details);
        }

        async function resizeImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = 'data:image/jpeg;base64,' + base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 600; // 確実性を高めるために少し小さく
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                img.onerror = () => resolve(base64Str);
            });
        }

        async function geminiFetch(payload) {
            // 安全なリクエスト構造
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (!response.ok) {
                const errMsg = data.error ? `${data.error.code}: ${data.error.message}` : `HTTP ${response.status}`;
                throw new Error(errMsg);
            }
            return data;
        }

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('error-log').style.display = 'none';
            document.getElementById('main-form-container').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            
            const msgTimer = setInterval(() => {
                document.getElementById('pos-message').textContent = messages[msgIndex];
                msgIndex = (msgIndex + 1) % messages.length;
            }, 2000);

            const reader = new FileReader();
            reader.onload = async (event) => {
                let originalBase64 = event.target.result.split(',')[1];
                document.getElementById('card-img-el').src = event.target.result;

                try {
                    const base64Data = await resizeImage(originalBase64);

                    const dish = document.getElementById('input-dish').value || "至高の料理";
                    const shop = document.getElementById('input-shop').value || "名もなき名店";
                    const points = document.getElementById('input-points').value || "とにかく美味しい！";
                    
                    const promptText = `あなたはプロの料理鑑定士です。この料理をTCGカードとしてデータ化してください。
出力は必ず以下のJSONフォーマットのみで行ってください。余計な説明文は一切不要です。

{
  "name": "二つ名付き料理名",
  "praise": "熱い食レポ。語尾は『〜なり！』か『〜である！』で。",
  "atk": 500〜9999の数値,
  "def": 500〜9999の数値,
  "rarity": "N, SR, URのどれか",
  "total_score": 50〜99の数値
}

料理情報:
名前: ${dish}
場所: ${shop}
感想: ${points}`;
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    };

                    const res = await geminiFetch(payload);
                    
                    if (!res.candidates || res.candidates.length === 0) {
                        throw new Error("AIが回答を作成できませんでした。別の画像で試してください。");
                    }

                    const rawText = res.candidates[0].content.parts[0].text;
                    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                    
                    if (!jsonMatch) {
                        throw new Error("AIの回答データが正しくありませんでした。");
                    }
                    
                    const result = JSON.parse(jsonMatch[0]);
                    
                    // カード反映
                    document.getElementById('card-name').textContent = result.name;
                    document.getElementById('praise-text').textContent = result.praise;
                    document.getElementById('val-atk').textContent = `ATK ${result.atk}`;
                    document.getElementById('val-def').textContent = `DEF ${result.def}`;
                    document.getElementById('val-score').textContent = result.total_score;
                    document.getElementById('rarity-icon').textContent = result.rarity;

                    const preview = document.getElementById('card-preview');
                    preview.classList.remove('effect-ur', 'effect-sr');
                    if (result.rarity === 'UR') preview.classList.add('effect-ur');
                    if (result.rarity === 'SR') preview.classList.add('effect-sr');

                    clearInterval(msgTimer);
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('result-area').style.display = 'flex';
                    setTimeout(() => preview.classList.add('active'), 100);

                } catch (err) {
                    clearInterval(msgTimer);
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('main-form-container').style.display = 'flex';
                    showError(err.message, "API通信またはデータ解析中にエラーが発生しました。");
                }
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('download-btn').onclick = async () => {
            const btn = document.getElementById('download-btn');
            btn.textContent = "保存中...";
            btn.disabled = true;
            const target = document.getElementById('card-preview');
            target.classList.add('is-exporting');
            
            try {
                const canvas = await html2canvas(target, { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `DeliciousCard.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (e) {
                alert("保存に失敗しました。");
            } finally {
                target.classList.remove('is-exporting');
                btn.textContent = "このカードを保存する";
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
