<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デリシャスデュエル - 究極の美食カード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f0f2f5;
            --card-frame: #fbc531;
            --gold: #ffd700;
            --silver: #bdc3c7;
            --gold-aura: rgba(255, 215, 0, 0.6);
        }

        body {
            background: radial-gradient(circle, #ffffff 0%, #dfe6e9 100%);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            color: #2d3436;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- UI Components --- */
        .card-container { width: 360px; height: 540px; perspective: 2000px; margin: 20px auto; }
        
        #card-preview {
            width: 360px; height: 540px;
            background: #fffdfa;
            border-radius: 24px; padding: 20px;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
            display: none; flex-direction: column;
            border: 12px solid var(--card-frame);
            overflow: hidden;
            transform-style: preserve-3d;
            background-clip: padding-box;
            box-sizing: border-box;
        }
        #card-preview.active { display: flex; animation: cardAppear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Rarity Effects */
        .effect-ur {
            border-color: var(--gold) !important;
            box-shadow: 0 0 50px var(--gold-aura), inset 0 0 20px var(--gold-aura) !important;
            animation: god-float 3s infinite ease-in-out !important;
        }
        .is-exporting { animation: none !important; transform: none !important; box-shadow: none !important; }

        .shine-layer {
            position: absolute; inset: 0; z-index: 32; pointer-events: none; opacity: 0;
            background: linear-gradient(105deg, transparent 30%, rgba(255,255,255,0.4) 45%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.4) 55%, transparent 70%);
            background-size: 200% 200%;
        }
        .effect-ur .shine-layer { opacity: 1; animation: shine-sweep 3s infinite linear; }

        .sparkle-layer {
            position: absolute; inset: -50%; z-index: 35; pointer-events: none; display: none;
            background-image: radial-gradient(circle, gold 1px, transparent 1px); background-size: 40px 40px;
        }
        .effect-ur .sparkle-layer { display: block; animation: god-sparkle 4s linear infinite; }
        .effect-sr { border-color: var(--silver) !important; box-shadow: 0 0 25px rgba(189, 195, 199, 0.6) !important; }

        @keyframes god-float { 0%, 100% { transform: translateY(0) rotateX(0deg); } 50% { transform: translateY(-10px) rotateX(2deg); } }
        @keyframes shine-sweep { 0% { background-position: -200% -200%; } 100% { background-position: 200% 200%; } }
        @keyframes god-sparkle { 0% { transform: translateY(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
        @keyframes cardAppear { 0% { transform: scale(0.5) rotateY(90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0); opacity: 1; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .screen-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        /* Card Contents */
        .card-header-area { display: flex; flex-direction: column; gap: 2px; margin-bottom: 8px; z-index: 10; }
        .title-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .name-container {
            border: 3px solid #2d3436; padding: 6px 10px; border-radius: 8px;
            background: rgba(255, 255, 255, 0.95); flex-grow: 1; margin-right: 8px; overflow: hidden;
        }
        #card-name { font-weight: 900; font-size: 1.1rem; color: #2d3436; margin: 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        #shop-name-display { font-size: 0.75rem; font-weight: 800; color: #636e72; padding-left: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 95%; }
        .rarity-icon { width: 40px; height: 40px; background: #2d3436; color: #fbc531; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 900; flex-shrink: 0; border: 2px solid #fbc531; }
        .photo-frame { width: 100%; height: 200px; border: 4px solid #fff; border-radius: 12px; overflow: hidden; margin-bottom: 12px; z-index: 10; background: #f1f2f6; }
        #card-img-el { width: 100%; height: 100%; object-fit: cover; }
        .description-box {
            flex-grow: 1; padding: 12px; background: rgba(255,255,255,0.9); border-radius: 12px; border: 2px dashed #dfe6e9;
            margin-bottom: 75px; z-index: 10; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #praise-text { font-size: 10px; font-weight: 700; line-height: 1.5; color: #2d3436; text-align: center; margin: 0; }
        .rank-badge { position: absolute; bottom: 35px; left: 20px; background: white; padding: 4px 12px; border-radius: 15px; border: 3px solid #fbc531; z-index: 40; text-align: center; }
        .rank-label { font-size: 8px; font-weight: 900; color: #b2bec3; }
        .rank-val { font-size: 24px; font-weight: 900; color: #ff7675; line-height: 1; }
        .battle-stats { position: absolute; bottom: 35px; right: 20px; display: flex; gap: 8px; z-index: 40; }
        .stat-box { background: #2d3436; color: white; padding: 4px 10px; border-radius: 10px; text-align: center; min-width: 65px; }
        .stat-label-jp { font-size: 7px; font-weight: 900; color: #b2bec3; }
        .stat-num { font-size: 16px; font-weight: 900; line-height: 1.1; }
        .collector-id { position: absolute; bottom: 10px; width: 100%; left: 0; text-align: center; font-size: 8px; font-weight: 900; color: #b2bec3; z-index: 40; }

        /* UI Panel */
        #main-form-container { display: flex; justify-content: center; align-items: center; width: 100%; max-width: 600px; padding: 20px; }
        .ui-card { background: white; border-radius: 35px; padding: 2.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 100%; }
        .input-jp { width: 100%; background: #f1f2f6; border: 3px solid transparent; border-radius: 18px; padding: 14px 22px; font-weight: 800; margin-bottom: 1rem; }
        .btn-action { background: #fbc531; color: #2d3436; padding: 1.2rem; border-radius: 22px; font-weight: 900; width: 100%; box-shadow: 0 6px 0 #e1b12c; cursor: pointer; transition: all 0.2s; }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 2px 0 #e1b12c; }
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body class="p-4">

    <header class="text-center mt-6 mb-4">
        <h1 class="text-3xl md:text-5xl font-black text-blue-500 italic">美味決闘 <span class="text-yellow-500">デリシャスデュエル</span></h1>
    </header>

    <div id="main-form-container">
        <div class="ui-card">
            <h2 class="text-center text-lg font-bold text-gray-500 mb-4">APIキー設定</h2>
            <div id="api-key-section" class="mb-6 bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                <p class="text-xs text-gray-500 mb-2">Google AI StudioのAPIキーを入力してください。<br>(入力は初回のみ。ブラウザに保存されます)</p>
                <input type="password" id="input-api-key" class="input-jp bg-white" placeholder="AIzaSy...">
                <button id="save-key-btn" class="bg-slate-800 text-white text-xs py-2 px-4 rounded-lg font-bold">キーを保存する</button>
                <span id="key-status" class="text-xs font-bold text-green-500 ml-2 hidden">保存済み！</span>
            </div>

            <hr class="border-gray-200 mb-6">

            <input type="text" id="input-dish" class="input-jp" placeholder="料理の名前（例：究極のオムライス）">
            <input type="text" id="input-shop" class="input-jp" placeholder="お店の名前（例：キッチン・ルミナス）">
            <textarea id="input-points" class="input-jp h-24" placeholder="美食ポイント（想いを込めるほどレア度UP！）"></textarea>
            
            <label class="block cursor-pointer">
                <div class="border-4 border-dashed border-slate-200 rounded-[25px] py-8 flex flex-col items-center hover:bg-slate-50 transition">
                    <span class="text-sm font-black text-slate-500">写真をアップロードして鑑定開始</span>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>
        </div>
    </div>

    <div id="loading-screen">
        <div class="text-2xl font-black text-yellow-500 mb-4 text-center">AI鑑定員が実食中...<br><span class="text-sm text-slate-400">（モデル探索中...）</span></div>
        <div id="pos-message" class="text-lg font-bold text-slate-500"></div>
    </div>

    <div id="result-area" class="hidden flex-col items-center mt-10 w-full">
        <div class="card-container">
            <div id="card-preview">
                <div class="shine-layer"></div>
                <div class="sparkle-layer"></div>
                <div class="card-header-area">
                    <div class="title-row">
                        <div class="name-container">
                            <h3 id="card-name">---</h3>
                        </div>
                        <div id="rarity-icon" class="rarity-icon">-</div>
                    </div>
                    <div id="shop-name-display">---</div>
                </div>
                <div class="photo-frame"><img src="" id="card-img-el"></div>
                <div class="description-box"><p id="praise-text"></p></div>
                <div class="rank-badge">
                    <div class="rank-label">おいしさ</div>
                    <div class="rank-val" id="val-score">00</div>
                </div>
                <div class="battle-stats">
                    <div class="stat-box">
                        <div class="stat-label-jp">こうげき</div>
                        <div class="stat-num" id="val-atk">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label-jp">ぼうぎょ</div>
                        <div class="stat-num" id="val-def">0</div>
                    </div>
                </div>
                <div class="collector-id">
                    No. <span id="serial-num">---</span> / DELICIOUS DUEL PREMIUM
                </div>
            </div>
        </div>
        <button id="download-btn" class="btn-action mt-6 max-w-sm">このカードを保存する</button>
        <button onclick="location.reload()" class="mt-4 text-slate-400 underline font-bold">もう一度作る</button>
        <button onclick="resetApiKey()" class="mt-2 text-xs text-red-300 underline">APIキーを削除</button>
    </div>

    <script>
        // APIキー管理
        const STORAGE_KEY = "delicious_duel_apikey_v2";
        let apiKey = localStorage.getItem(STORAGE_KEY) || "";

        // UI初期化
        if (apiKey) {
            document.getElementById('input-api-key').value = "****************";
            document.getElementById('input-api-key').disabled = true;
            document.getElementById('key-status').classList.remove('hidden');
            document.getElementById('save-key-btn').textContent = "変更する";
        }

        document.getElementById('save-key-btn').addEventListener('click', () => {
            const input = document.getElementById('input-api-key');
            if (input.disabled) {
                input.disabled = false;
                input.value = "";
                input.focus();
                document.getElementById('save-key-btn').textContent = "保存する";
                document.getElementById('key-status').classList.add('hidden');
            } else {
                const val = input.value.trim();
                if (val) {
                    apiKey = val;
                    localStorage.setItem(STORAGE_KEY, val);
                    input.value = "****************";
                    input.disabled = true;
                    document.getElementById('key-status').classList.remove('hidden');
                    document.getElementById('save-key-btn').textContent = "変更する";
                }
            }
        });

        function resetApiKey() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        const messages = ["香りを分析中...", "旨味成分を計算中...", "隠し味を特定中...", "伝説のレシピと照合中...", "最高の一言を考案中..."];
        let msgIndex = 0;

        // 画像リサイズ（軽量化）
        async function resizeImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = 'data:image/jpeg;base64,' + base64Str;
                img.onerror = () => resolve(base64Str);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 800; 
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                };
            });
        }

        // 堅牢なフェッチ関数（リトライ＆モデル切替）
        async function geminiFetch(payload) {
            if (!apiKey) throw new Error("APIキーが設定されていません。上の欄に入力して保存してください。");
            
            // 使用するモデルの優先順位リスト
            const models = [
                "gemini-2.0-flash",
                "gemini-1.5-flash",
                "gemini-1.5-pro"
            ];
            
            let lastErrorMsg = "";

            for (const modelName of models) {
                // v1betaエンドポイントを使用
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                try {
                    console.log(`Trying model: ${modelName}`);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        const errCode = data.error?.code || response.status;
                        const errMsg = data.error?.message || response.statusText;
                        throw new Error(`${errCode}: ${errMsg}`);
                    }
                    
                    // 成功したらデータを返す
                    return data;

                } catch (e) {
                    console.warn(`${modelName} failed:`, e.message);
                    lastErrorMsg = e.message;
                    // APIキー自体のエラー（400, 403）の場合はリトライしても無駄なのでループを抜ける
                    if (e.message.includes("400") || e.message.includes("403")) {
                        throw new Error("APIキーが無効です。正しいキーを入力し直してください。");
                    }
                }
            }
            throw new Error(`全モデルで失敗しました: ${lastErrorMsg}`);
        }

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!apiKey) {
                alert("先にAPIキーを入力して保存ボタンを押してください！");
                return;
            }

            document.getElementById('main-form-container').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            
            const msgTimer = setInterval(() => {
                document.getElementById('pos-message').textContent = messages[msgIndex];
                msgIndex = (msgIndex + 1) % messages.length;
            }, 2500);

            const reader = new FileReader();
            reader.onload = async (event) => {
                let base64Data = event.target.result.split(',')[1];
                document.getElementById('card-img-el').src = event.target.result;

                try {
                    // 画像軽量化
                    base64Data = await resizeImage(base64Data);

                    const dish = document.getElementById('input-dish').value || "至高の料理";
                    const shop = document.getElementById('input-shop').value || "名もなき名店";
                    const points = document.getElementById('input-points').value || "とにかく美味しい！";
                    
                    const promptText = `あなたはプロの料理鑑定士です。画像と情報を元に、TCGカードのパラメータを決定してください。
以下のJSON形式のみを出力してください。Markdownや余計な文字は一切禁止。

料理名: ${dish}
店名: ${shop}
感想: ${points}

{
  "name": "二つ名付き料理名(15文字以内)",
  "praise": "熱い食レポ(80文字以内)。語尾は『〜なり！』など。",
  "atk": 500から9999の数値,
  "def": 500から9999の数値,
  "rarity": "N, SR, URのどれか",
  "total_score": 50から99の数値
}`;
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            maxOutputTokens: 1000
                        }
                    };

                    const res = await geminiFetch(payload);
                    
                    if (!res.candidates || res.candidates.length === 0 || !res.candidates[0].content) {
                        throw new Error("AIからの回答が空でした。");
                    }

                    let textResult = res.candidates[0].content.parts[0].text;
                    
                    // 強力なJSON抽出（Markdownや不要な文字列を削除）
                    const jsonMatch = textResult.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("AIの回答形式が不正でした。");
                    
                    const result = JSON.parse(jsonMatch[0]);
                    
                    document.getElementById('card-name').textContent = result.name || dish;
                    document.getElementById('shop-name-display').textContent = shop;
                    document.getElementById('praise-text').textContent = result.praise || "解析不能";
                    document.getElementById('val-atk').textContent = result.atk || 1000;
                    document.getElementById('val-def').textContent = result.def || 1000;
                    document.getElementById('val-score').textContent = result.total_score || 50;
                    document.getElementById('rarity-icon').textContent = result.rarity || "N";

                    const preview = document.getElementById('card-preview');
                    preview.classList.remove('effect-ur', 'effect-sr');
                    if (result.rarity === 'UR') preview.classList.add('effect-ur');
                    if (result.rarity === 'SR') preview.classList.add('effect-sr');

                    clearInterval(msgTimer);
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('result-area').style.display = 'flex';
                    setTimeout(() => preview.classList.add('active'), 100);
                    
                    if(result.rarity === 'UR') {
                        document.body.classList.add('screen-shake');
                        setTimeout(() => document.body.classList.remove('screen-shake'), 500);
                    }

                } catch (err) {
                    clearInterval(msgTimer);
                    alert("エラーが発生しました:\n" + err.message);
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('main-form-container').style.display = 'flex';
                }
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('download-btn').onclick = async () => {
            const btn = document.getElementById('download-btn');
            btn.textContent = "保存中...";
            btn.disabled = true;

            const target = document.getElementById('card-preview');
            target.classList.add('is-exporting');
            
            try {
                const canvas = await html2canvas(target, { 
                    scale: 3, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false
                });
                const link = document.createElement('a');
                link.download = `DeliciousCard_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (e) {
                alert("保存に失敗しました。");
            } finally {
                target.classList.remove('is-exporting');
                btn.textContent = "このカードを保存する";
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
